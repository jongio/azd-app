---
/**
 * CopyButton Component
 * 
 * A reusable button that copies text to clipboard with visual feedback.
 * Supports multiple sizes and variants.
 */

interface Props {
  /** Text to copy to clipboard */
  text: string;
  /** Size variant */
  size?: 'sm' | 'md' | 'lg';
  /** Visual variant */
  variant?: 'icon' | 'button';
  /** Custom label text */
  label?: string;
  /** Additional CSS classes */
  class?: string;
}

const {
  text,
  size = 'md',
  variant = 'icon',
  label = 'Copy',
  class: className = '',
} = Astro.props;

const sizeClasses = {
  sm: 'copy-button--sm',
  md: 'copy-button--md',
  lg: 'copy-button--lg',
};

const variantClasses = {
  icon: 'copy-button--icon',
  button: 'copy-button--button',
};
---

<button
  type="button"
  class:list={[
    'copy-button',
    sizeClasses[size],
    variantClasses[variant],
    className,
  ]}
  data-copy-text={text}
  aria-label={label}
>
  <span class="copy-button-icons">
    <!-- Copy Icon -->
    <svg
      class="copy-icon"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true"
    >
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </svg>
    
    <!-- Check Icon (Success) -->
    <svg
      class="check-icon"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true"
    >
      <polyline points="20 6 9 17 4 12"></polyline>
    </svg>
    
    <!-- Error Icon -->
    <svg
      class="error-icon"
      width="16"
      height="16"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true"
    >
      <line x1="18" y1="6" x2="6" y2="18"></line>
      <line x1="6" y1="6" x2="18" y2="18"></line>
    </svg>
  </span>
  
  {variant === 'button' && (
    <span class="copy-button-label">{label}</span>
  )}
</button>

<!-- Screen reader announcer -->
<span
  class="copy-status-announcer sr-only"
  role="status"
  aria-live="polite"
></span>

<style>
  /* Copy Button Base Styles */
  .copy-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: background-color 0.15s ease-out, transform 0.15s ease-out;
    color: var(--copy-button-icon-color);
    position: relative;
  }

  .copy-button:hover {
    background-color: var(--copy-button-bg-hover);
    color: var(--copy-button-icon-hover);
  }

  .copy-button:active {
    transform: scale(0.95);
    background-color: var(--copy-button-bg-active);
  }

  .copy-button:focus-visible {
    outline: 2px solid var(--color-border-focus);
    outline-offset: 2px;
  }

  .copy-button:focus:not(:focus-visible) {
    outline: none;
  }

  /* Size Variants */
  .copy-button--sm {
    min-width: 28px;
    min-height: 28px;
    padding: 6px;
  }

  .copy-button--md {
    min-width: 32px;
    min-height: 32px;
    padding: 8px;
  }

  .copy-button--lg {
    min-width: 40px;
    min-height: 40px;
    padding: 10px;
  }

  .copy-button--button {
    padding-left: 10px;
    padding-right: 12px;
  }

  /* Icon Container */
  .copy-button-icons {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
  }

  .copy-button--sm .copy-button-icons {
    width: 14px;
    height: 14px;
  }

  .copy-button--lg .copy-button-icons {
    width: 20px;
    height: 20px;
  }

  .copy-button--sm .copy-button-icons svg {
    width: 14px;
    height: 14px;
  }

  .copy-button--lg .copy-button-icons svg {
    width: 20px;
    height: 20px;
  }

  /* Icon States */
  .copy-icon,
  .check-icon,
  .error-icon {
    position: absolute;
    transition: opacity 0.15s ease-out, transform 0.15s ease-out;
  }

  .copy-icon {
    opacity: 1;
    transform: scale(1);
  }

  .check-icon,
  .error-icon {
    opacity: 0;
    transform: scale(0.5);
  }

  /* Copied State */
  .copy-button[data-status="copied"] {
    color: var(--copy-button-success-icon);
    background-color: var(--copy-button-success-bg);
  }

  .copy-button[data-status="copied"] .copy-icon {
    opacity: 0;
    transform: scale(0.5);
  }

  .copy-button[data-status="copied"] .check-icon {
    opacity: 1;
    transform: scale(1);
    animation: copy-success 0.3s ease-out;
  }

  /* Error State */
  .copy-button[data-status="error"] {
    color: var(--copy-button-error-icon);
    background-color: var(--copy-button-error-bg);
  }

  .copy-button[data-status="error"] .copy-icon {
    opacity: 0;
    transform: scale(0.5);
  }

  .copy-button[data-status="error"] .error-icon {
    opacity: 1;
    transform: scale(1);
  }

  /* Label */
  .copy-button-label {
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    transition: color 0.15s ease-out;
  }

  .copy-button[data-status="copied"] .copy-button-label::after {
    content: "Copied!";
  }

  .copy-button[data-status="copied"] .copy-button-label {
    color: var(--copy-button-success-text);
  }

  .copy-button[data-status="error"] .copy-button-label::after {
    content: "Failed";
  }

  .copy-button[data-status="error"] .copy-button-label {
    color: var(--copy-button-error-text);
  }

  /* Hide original label text when showing status */
  .copy-button[data-status="copied"] .copy-button-label,
  .copy-button[data-status="error"] .copy-button-label {
    font-size: 0;
  }

  .copy-button[data-status="copied"] .copy-button-label::after,
  .copy-button[data-status="error"] .copy-button-label::after {
    font-size: 13px;
  }

  /* Animations */
  @keyframes copy-success {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      transform: scale(1);
    }
  }

  /* Screen Reader Only */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Touch Targets */
  @media (pointer: coarse) {
    .copy-button {
      min-width: 44px;
      min-height: 44px;
    }
  }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    .copy-button,
    .copy-icon,
    .check-icon,
    .error-icon,
    .copy-button-label {
      transition: none;
      animation: none;
    }
  }
</style>

<script>
  const FEEDBACK_DURATION = 2000;

  async function copyToClipboard(text: string): Promise<void> {
    if (navigator.clipboard?.writeText) {
      return navigator.clipboard.writeText(text);
    }

    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    textarea.style.pointerEvents = 'none';
    document.body.appendChild(textarea);
    textarea.select();

    try {
      const success = document.execCommand('copy');
      if (!success) throw new Error('Copy command failed');
    } finally {
      document.body.removeChild(textarea);
    }
  }

  function announceToSR(message: string, button: HTMLButtonElement): void {
    const announcer = button.nextElementSibling as HTMLElement;
    if (announcer?.classList.contains('copy-status-announcer')) {
      announcer.textContent = message;
    }
  }

  function initCopyButtons(): void {
    document.querySelectorAll<HTMLButtonElement>('.copy-button').forEach((button) => {
      if (button.dataset.initialized) return;
      button.dataset.initialized = 'true';

      let timeoutId: number | undefined;

      button.addEventListener('click', async () => {
        const text = button.dataset.copyText;
        if (!text || button.dataset.status !== undefined) return;

        if (timeoutId) {
          clearTimeout(timeoutId);
        }

        try {
          await copyToClipboard(text);
          button.dataset.status = 'copied';
          announceToSR('Copied to clipboard', button);
        } catch (error) {
          button.dataset.status = 'error';
          announceToSR('Failed to copy', button);
        }

        timeoutId = window.setTimeout(() => {
          delete button.dataset.status;
        }, FEEDBACK_DURATION);
      });
    });
  }

  // Initialize on load
  initCopyButtons();

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initCopyButtons);
</script>
