{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/jongio/azd-app/main/schemas/v1.1/azure.yaml.json",
  "title": "Azure Developer CLI (azd app) Configuration",
  "description": "Schema for azure.yaml configuration file used by azd app for local development orchestration",
  "type": "object",
  "required": ["name"],
  "properties": {
    "name": {
      "type": "string",
      "description": "The name of the application",
      "pattern": "^[a-zA-Z0-9-_]+$",
      "minLength": 1,
      "maxLength": 64
    },
    "services": {
      "type": "object",
      "description": "Map of service definitions for local development",
      "additionalProperties": {
        "$ref": "#/definitions/service"
      }
    },
    "resources": {
      "type": "object",
      "description": "Map of Azure resource definitions",
      "additionalProperties": {
        "$ref": "#/definitions/resource"
      }
    },
    "reqs": {
      "type": "array",
      "description": "List of prerequisite tools required to run the application",
      "items": {
        "$ref": "#/definitions/requirement"
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional metadata for the application",
      "additionalProperties": true
    },
    "hooks": {
      "type": "object",
      "title": "Command level hooks",
      "description": "Hooks for azd app commands. Paths should be relative to the project path.",
      "additionalProperties": false,
      "properties": {
        "prerun": {
          "title": "pre run hook",
          "description": "Runs before the `run` command",
          "$ref": "#/definitions/hook"
        },
        "postrun": {
          "title": "post run hook",
          "description": "Runs after the `run` command",
          "$ref": "#/definitions/hook"
        }
      }
    },
    "logs": {
      "$ref": "#/definitions/logsConfig",
      "description": "Project-level logging configuration"
    }
  },
  "definitions": {
    "service": {
      "type": "object",
      "description": "A service definition for local development",
      "properties": {
        "host": {
          "type": "string",
          "description": "The hosting platform (from original azure.yaml schema)"
        },
        "language": {
          "type": "string",
          "description": "The programming language of the service (from original schema)",
          "enum": ["js", "ts", "py", "python", "csharp", "dotnet", "go", "java", "rust", "ruby", "php", "aspire"],
          "examples": ["TypeScript", "Python", "csharp"]
        },
        "project": {
          "type": "string",
          "description": "Relative path to the service project directory (from original schema)"
        },
        "entrypoint": {
          "type": "string",
          "description": "Entry point file for the service (e.g., main.py, app.py) - azd app addition"
        },
        "image": {
          "type": "string",
          "description": "Docker image name for the service (from original schema)"
        },
        "docker": {
          "$ref": "#/definitions/dockerConfig",
          "description": "Docker build configuration (from original schema)"
        },
        "ports": {
          "type": "array",
          "description": "Port mappings in Docker Compose style - azd app addition for local development",
          "items": {
            "type": "string",
            "pattern": "^(\\d+|\\d+:\\d+|[\\da-fA-F:.]+:\\d+:\\d+)(\\/[a-z]+)?$"
          },
          "examples": [
            ["3000"],
            ["3000:8080"],
            ["127.0.0.1:3000:8080"],
            ["8080/udp"],
            ["[::1]:3000:8080"]
          ]
        },
        "environment": {
          "type": ["array", "object"],
          "description": "Environment variables for the service - azd app addition (Docker Compose compatible)",
          "items": {
            "$ref": "#/definitions/envVar"
          },
          "additionalProperties": {
            "type": "string"
          }
        },
        "uses": {
          "type": "array",
          "description": "List of resource or service names that this service depends on (from original schema)",
          "items": {
            "type": "string"
          }
        },
        "logs": {
          "$ref": "#/definitions/logsConfig",
          "description": "Service-level logging configuration"
        }
      }
    },
    "dockerConfig": {
      "type": "object",
      "description": "Docker build configuration",
      "properties": {
        "path": {
          "type": "string",
          "description": "Path to Dockerfile"
        },
        "context": {
          "type": "string",
          "description": "Docker build context directory"
        },
        "platform": {
          "type": "string",
          "description": "Target platform (e.g., linux/amd64, linux/arm64)",
          "examples": ["linux/amd64", "linux/arm64", "linux/arm/v7"]
        },
        "registry": {
          "type": "string",
          "description": "Container registry URL"
        },
        "image": {
          "type": "string",
          "description": "Image name"
        },
        "tag": {
          "type": "string",
          "description": "Image tag",
          "default": "latest"
        },
        "buildArgs": {
          "type": "array",
          "description": "Build arguments for Docker build",
          "items": {
            "type": "string"
          }
        },
        "remoteBuild": {
          "type": "boolean",
          "description": "Whether to build the image remotely (e.g., using Azure Container Registry)",
          "default": false
        }
      }
    },
    "envVar": {
      "type": "object",
      "description": "Environment variable definition",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Environment variable name"
        },
        "value": {
          "type": "string",
          "description": "Environment variable value (plain text)"
        },
        "secret": {
          "type": "string",
          "description": "Reference to a secret value (mutually exclusive with value)"
        }
      },
      "oneOf": [
        {
          "required": ["value"]
        },
        {
          "required": ["secret"]
        }
      ]
    },
    "resource": {
      "type": "object",
      "description": "An Azure resource definition",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "description": "The type of Azure resource",
          "examples": ["Microsoft.Storage/storageAccounts", "Microsoft.KeyVault/vaults", "Microsoft.Sql/servers"]
        },
        "uses": {
          "type": "array",
          "description": "List of other resources this resource depends on",
          "items": {
            "type": "string"
          }
        },
        "existing": {
          "type": "boolean",
          "description": "Whether this is an existing resource (not provisioned by azd)",
          "default": false
        }
      }
    },
    "requirement": {
      "type": "object",
      "description": "A prerequisite tool or dependency requirement - azd app addition",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the required tool",
          "examples": ["node", "python", "docker", "azd", "dotnet", "go", "java"]
        },
        "minVersion": {
          "type": "string",
          "description": "Minimum required version"
        },
        "command": {
          "type": "string",
          "description": "Override command to execute for version check"
        },
        "args": {
          "type": "array",
          "description": "Override arguments for version check",
          "items": {
            "type": "string"
          }
        },
        "versionPrefix": {
          "type": "string",
          "description": "Override version prefix to strip (e.g., 'v')"
        },
        "versionField": {
          "type": "integer",
          "description": "Override which field contains version (0 = whole output)"
        },
        "checkRunning": {
          "type": "boolean",
          "description": "Whether to verify the tool is running (e.g., for Docker daemon)",
          "default": false
        },
        "runningCheckCommand": {
          "type": "string",
          "description": "Command to check if tool is running"
        },
        "runningCheckArgs": {
          "type": "array",
          "description": "Arguments for running check command",
          "items": {
            "type": "string"
          }
        },
        "runningCheckExpected": {
          "type": "string",
          "description": "Expected substring in running check output"
        },
        "runningCheckExitCode": {
          "type": "integer",
          "description": "Expected exit code for running check (default: 0)"
        }
      }
    },
    "shellType": {
      "type": "string",
      "description": "Supported shell types for executing hook scripts",
      "enum": [
        "sh",
        "bash",
        "pwsh",
        "powershell",
        "cmd"
      ]
    },
    "hook": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "shell": {
          "$ref": "#/definitions/shellType",
          "title": "Type of shell to execute scripts",
          "description": "Optional. The type of shell to use for the hook. The default shell is platform-dependent (e.g., pwsh/powershell/cmd on Windows, bash/sh on POSIX)."
        },
        "run": {
          "type": "string",
          "title": "Script or command to execute",
          "description": "When specifying an inline script you also must specify the `shell` to use. This is automatically inferred when using paths. Hooks receive environment variables: AZD_APP_PROJECT_DIR (project directory path), AZD_APP_PROJECT_NAME (project name), AZD_APP_SERVICE_COUNT (number of services)."
        },
        "continueOnError": {
          "type": "boolean",
          "default": false,
          "title": "Whether or not a script error will halt the azd command",
          "description": "Optional. When set to true will continue to run the command even after a script error has occurred. (Default: false)"
        },
        "interactive": {
          "type": "boolean",
          "default": false,
          "title": "Whether the script will run in interactive mode",
          "description": "Optional. When set to true will bind the script to stdin, stdout & stderr of the running console. (Default: false)"
        },
        "windows": {
          "title": "The hook configuration used for Windows environments",
          "description": "When specified overrides the hook configuration when executed in Windows environments",
          "default": null,
          "$ref": "#/definitions/platformHookOverride"
        },
        "posix": {
          "title": "The hook configuration used for POSIX (Linux & MacOS) environments",
          "description": "When specified overrides the hook configuration when executed in POSIX environments",
          "default": null,
          "$ref": "#/definitions/platformHookOverride"
        }
      },
      "allOf": [
        {
          "if": {
            "allOf": [
              {
                "required": [
                  "windows"
                ]
              },
              {
                "required": [
                  "posix"
                ]
              }
            ]
          },
          "then": {
            "properties": {
              "run": false,
              "shell": false,
              "interactive": false,
              "continueOnError": false
            }
          }
        },
        {
          "if": {
            "anyOf": [
              {
                "required": [
                  "interactive"
                ]
              },
              {
                "required": [
                  "continueOnError"
                ]
              },
              {
                "required": [
                  "shell"
                ]
              }
            ]
          },
          "then": {
            "required": [
              "run"
            ]
          }
        }
      ]
    },
    "platformHookOverride": {
      "type": "object",
      "additionalProperties": false,
      "description": "Platform-specific hook override that cannot contain nested platform overrides",
      "properties": {
        "shell": {
          "$ref": "#/definitions/shellType",
          "title": "Type of shell to execute scripts",
          "description": "Optional. The type of shell to use for the hook. The default shell is platform-dependent."
        },
        "run": {
          "type": "string",
          "title": "Script or command to execute",
          "description": "When specifying an inline script you also must specify the `shell` to use. Hooks receive environment variables: AZD_APP_PROJECT_DIR, AZD_APP_PROJECT_NAME, AZD_APP_SERVICE_COUNT."
        },
        "continueOnError": {
          "type": "boolean",
          "default": false,
          "title": "Whether or not a script error will halt the azd command"
        },
        "interactive": {
          "type": "boolean",
          "default": false,
          "title": "Whether the script will run in interactive mode"
        }
      }
    },
    "logsConfig": {
      "type": "object",
      "description": "Logging configuration for the project or service",
      "additionalProperties": false,
      "properties": {
        "filters": {
          "$ref": "#/definitions/logFilterConfig",
          "description": "Filter configuration to suppress noisy log output"
        }
      }
    },
    "logFilterConfig": {
      "type": "object",
      "description": "Log filtering configuration to suppress noisy output patterns",
      "additionalProperties": false,
      "properties": {
        "exclude": {
          "type": "array",
          "description": "Regex patterns to filter out (suppress) from log output. Patterns are case-insensitive.",
          "items": {
            "type": "string"
          },
          "examples": [
            ["npm warn", "Debugger listening", "ExperimentalWarning"]
          ]
        },
        "includeBuiltins": {
          "type": "boolean",
          "default": true,
          "description": "Whether to include built-in filter patterns for common noise (Electron DevTools errors, npm warnings, etc.). Defaults to true."
        }
      }
    }
  },
  "examples": [
    {
      "name": "fullstack-app",
      "services": {
        "web": {
          "language": "TypeScript",
          "project": "./frontend",
          "ports": ["3000"],
          "environment": [
            {
              "name": "API_URL",
              "value": "http://localhost:8000"
            }
          ],
          "uses": ["api"]
        },
        "api": {
          "language": "Python",
          "project": "./backend",
          "entrypoint": "main.py",
          "ports": ["8000"],
          "environment": [
            {
              "name": "DATABASE_URL",
              "secret": "POSTGRES_CONNECTION_STRING"
            }
          ],
          "uses": ["db"]
        }
      },
      "resources": {
        "db": {
          "type": "Microsoft.Sql/servers"
        }
      },
      "reqs": [
        {
          "name": "node",
          "minVersion": "18.0.0"
        },
        {
          "name": "python",
          "minVersion": "3.9"
        },
        {
          "name": "docker",
          "checkRunning": true
        }
      ],
      "hooks": {
        "prerun": {
          "run": "./scripts/prerun.sh",
          "shell": "sh",
          "continueOnError": false
        },
        "postrun": {
          "run": "echo 'All services are ready!'",
          "shell": "sh"
        }
      }
    }
  ]
}
