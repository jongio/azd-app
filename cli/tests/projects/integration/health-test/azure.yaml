# yaml-language-server: $schema=https://raw.githubusercontent.com/jongio/azd-app/main/schemas/v1.1/azure.yaml.json

name: health-monitoring-test
metadata:
  template: health-monitoring-test
  description: Comprehensive test project for azd app health command with all health check types

reqs:
  - name: node
    minVersion: 18.0.0
  - name: npm
    minVersion: 9.0.0
  - name: python
    minVersion: 3.9.0

services:
  # Service 1: HTTP health check with custom endpoint
  web:
    language: node
    project: ./web
    host: localhost
    ports:
      - "3000"
    environment:
      NODE_ENV: development
    healthcheck:
      test: "http://localhost:3000/health"
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
      start_interval: 5s

  # Service 2: HTTP health check with standard endpoints
  api:
    language: python
    project: ./api
    host: localhost
    ports:
      - "5000"
    environment:
      FLASK_ENV: development
      FLASK_APP: app.py
    healthcheck:
      test: "http://localhost:5000/healthz"
      interval: 15s
      timeout: 3s
      retries: 2
      start_period: 20s

  # Service 3: TCP port check (no HTTP health endpoint)
  database:
    language: node
    project: ./database
    host: localhost
    ports:
      - "5432"
    environment:
      POSTGRES_DB: testdb
      POSTGRES_USER: testuser
    # No healthcheck specified - will fall back to port check

  # Service 4: Process-only check (background worker, no port)
  worker:
    language: python
    project: ./worker
    host: localhost
    entrypoint: worker
    environment:
      WORKER_MODE: background
    # No port, no healthcheck - will use process check only

  # Service 5: Health check with authentication headers
  admin:
    language: node
    project: ./admin
    host: localhost
    ports:
      - "4000"
    environment:
      NODE_ENV: development
      ADMIN_TOKEN: test-token-123
    healthcheck:
      test: "http://localhost:4000/api/health"
      interval: 5s
      timeout: 2s
      retries: 1
