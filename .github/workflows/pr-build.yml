name: PR Build

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main ]
  pull_request_target:
    branches: [ main ]
    types: [labeled, closed]
  push:
    branches: [ prbuild ]
    paths:
      - 'cli/**'
      - '.github/workflows/pr-build.yml'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to build'
        required: false
        type: number

defaults:
  run:
    working-directory: cli

jobs:
  # Check if build should run
  check-permission:
    name: Check Build Permission
    runs-on: ubuntu-latest
    # Only run if:
    # 1. CI workflow succeeded, OR
    # Only run if:
    # 1. CI workflow succeeded, OR
    # 2. Manual trigger via workflow_dispatch, OR
    # 3. PR labeled with 'safe-to-build', OR
    # 4. Push to prbuild branch (for testing)
    if: |
      github.event_name == 'workflow_dispatch' || 
      github.event_name == 'pull_request_target' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      allowed: ${{ steps.check.outputs.allowed }}
      pr_number: ${{ steps.check.outputs.pr_number }}
      pr_sha: ${{ steps.check.outputs.pr_sha }}
    
    steps:
      - name: Check if build is allowed
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            let allowed = false;
            let prNumber = null;
            let prSha = null;
            
            // Workflow dispatch - always allowed
            if (context.eventName === 'workflow_dispatch') {
              allowed = true;
              prNumber = context.payload.inputs.pr_number;
              if (prNumber) {
                const pr = await github.rest.pulls.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber
                });
                prSha = pr.data.head.sha;
              }
              core.setOutput('allowed', 'true');
              core.setOutput('pr_number', prNumber || '');
              core.setOutput('pr_sha', prSha || '');
              return;
            }
            
            // push event (for testing on prbuild branch)
            if (context.eventName === 'push') {
              allowed = true;
              // Find PR for this branch
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`
              });
              
              if (prs.length > 0) {
                prNumber = prs[0].number;
                prSha = prs[0].head.sha;
              }
              core.setOutput('allowed', 'true');
              core.setOutput('pr_number', prNumber || '');
              core.setOutput('pr_sha', prSha || '');
              return;
            }
            
            // workflow_run - triggered after CI passes
            if (context.eventName === 'workflow_run') {
              // Get the PR associated with the workflow run
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
              });
              
              if (prs.length > 0) {
                const pr = prs[0];
                const association = pr.author_association;
                
                // Check if trusted contributor
                const trustedAssociations = ['OWNER', 'MEMBER', 'COLLABORATOR', 'CONTRIBUTOR'];
                if (trustedAssociations.includes(association)) {
                  allowed = true;
                  prNumber = pr.number;
                  prSha = pr.head.sha;
                } else {
                  // For first-time contributors, check if they have the label
                  const hasLabel = pr.labels.some(label => label.name === 'safe-to-build');
                  if (hasLabel) {
                    allowed = true;
                    prNumber = pr.number;
                    prSha = pr.head.sha;
                  }
                }
              }
            }
            
            // pull_request_target with 'safe-to-build' label
            if (context.eventName === 'pull_request_target') {
              const hasLabel = context.payload.pull_request.labels.some(
                label => label.name === 'safe-to-build'
              );
              if (hasLabel) {
                allowed = true;
                prNumber = context.payload.pull_request.number;
                prSha = context.payload.pull_request.head.sha;
              }
            }
            
            core.setOutput('allowed', allowed ? 'true' : 'false');
            core.setOutput('pr_number', prNumber || '');
            core.setOutput('pr_sha', prSha || '');
            
            if (!allowed) {
              core.notice('Build skipped - requires maintainer approval. Add "safe-to-build" label to proceed.');
            }

  build-pr:
    name: Build PR Preview
    runs-on: ubuntu-latest
    needs: check-permission
    if: needs.check-permission.outputs.allowed == 'true'
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Get PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = '${{ needs.check-permission.outputs.pr_number }}' || context.payload.pull_request.number;
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            core.setOutput('number', prNumber);
            core.setOutput('sha', pr.data.head.sha);
            core.setOutput('ref', pr.data.head.ref);
            core.setOutput('title', pr.data.title);

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.sha }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache-dependency-path: cli/go.sum

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: cli/dashboard/package.json

      - name: Calculate PR version
        id: version
        working-directory: cli
        run: |
          BASE_VERSION=$(grep '^version:' extension.yaml | awk '{print $2}')
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          PR_VERSION="${BASE_VERSION}-pr${PR_NUMBER}"
          # Use the standard azd extension tag format so azd x publish generates correct URLs
          STANDARD_TAG="azd-ext-jongio-azd-app_${PR_VERSION}"
          echo "version=$PR_VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$STANDARD_TAG" >> $GITHUB_OUTPUT
          echo "Building version: $PR_VERSION with tag: $STANDARD_TAG"

      - name: Install azd
        run: curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Install azd extensions
        run: azd extension install microsoft.azd.extensions

      - name: Build dashboard
        working-directory: cli
        run: |
          cd dashboard
          npm ci
          npm run build

      - name: Build binaries
        working-directory: cli
        run: |
          export EXTENSION_ID="jongio.azd.app"
          export EXTENSION_VERSION="${{ steps.version.outputs.version }}"
          azd x build --all

      - name: Package
        working-directory: cli
        run: azd x pack

      - name: Prepare artifacts for upload
        run: |
          BASE_VERSION="${{ steps.version.outputs.base_version }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # Create artifacts directory
          mkdir -p /tmp/pr-artifacts
          
          # Copy all archives to artifacts directory
          cp ~/.azd/registry/jongio.azd.app/${BASE_VERSION}/* /tmp/pr-artifacts/
          
          # Create PR registry manually with correct version
          cat > /tmp/pr-artifacts/pr-registry.json <<'EOF'
          {
            "extensions": [
              {
                "id": "jongio.azd.app",
                "namespace": "app",
                "displayName": "App Extension (PR Build)",
                "description": "PR preview build - A collection of developer productivity commands for Azure Developer CLI",
                "versions": [
                  {
                    "version": "VERSION_PLACEHOLDER",
                    "capabilities": [
                      "custom-commands",
                      "lifecycle-events",
                      "mcp-server"
                    ],
                    "usage": "azd app <command> [options]",
                    "examples": [
                      {
                        "name": "hi",
                        "description": "Say hello and display extension info",
                        "usage": "azd app hi"
                      },
                      {
                        "name": "reqs",
                        "description": "Verify all prerequisites are installed",
                        "usage": "azd app reqs"
                      }
                    ],
                    "artifacts": {
                      "darwin/amd64": {
                        "checksum": {
                          "algorithm": "sha256",
                          "value": "DARWIN_AMD64_CHECKSUM"
                        },
                        "entryPoint": "jongio-azd-app-darwin-amd64",
                        "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/jongio-azd-app-darwin-amd64.zip"
                      },
                      "darwin/arm64": {
                        "checksum": {
                          "algorithm": "sha256",
                          "value": "DARWIN_ARM64_CHECKSUM"
                        },
                        "entryPoint": "jongio-azd-app-darwin-arm64",
                        "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/jongio-azd-app-darwin-arm64.zip"
                      },
                      "linux/amd64": {
                        "checksum": {
                          "algorithm": "sha256",
                          "value": "LINUX_AMD64_CHECKSUM"
                        },
                        "entryPoint": "jongio-azd-app-linux-amd64",
                        "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/jongio-azd-app-linux-amd64.tar.gz"
                      },
                      "linux/arm64": {
                        "checksum": {
                          "algorithm": "sha256",
                          "value": "LINUX_ARM64_CHECKSUM"
                        },
                        "entryPoint": "jongio-azd-app-linux-arm64",
                        "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/jongio-azd-app-linux-arm64.tar.gz"
                      },
                      "windows/amd64": {
                        "checksum": {
                          "algorithm": "sha256",
                          "value": "WINDOWS_AMD64_CHECKSUM"
                        },
                        "entryPoint": "jongio-azd-app-windows-amd64.exe",
                        "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/jongio-azd-app-windows-amd64.zip"
                      },
                      "windows/arm64": {
                        "checksum": {
                          "algorithm": "sha256",
                          "value": "WINDOWS_ARM64_CHECKSUM"
                        },
                        "entryPoint": "jongio-azd-app-windows-arm64.exe",
                        "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/jongio-azd-app-windows-arm64.zip"
                      }
                    },
                    "entryPoint": "app"
                  }
                ],
                "tags": [
                  "developer",
                  "productivity",
                  "app",
                  "pr-build"
                ]
              }
            ]
          }
          EOF
          
          # Replace version placeholder
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" /tmp/pr-artifacts/pr-registry.json
          
          # Calculate checksums and update registry
          DARWIN_AMD64_SHA=$(sha256sum /tmp/pr-artifacts/jongio-azd-app-darwin-amd64.zip | awk '{print $1}')
          DARWIN_ARM64_SHA=$(sha256sum /tmp/pr-artifacts/jongio-azd-app-darwin-arm64.zip | awk '{print $1}')
          LINUX_AMD64_SHA=$(sha256sum /tmp/pr-artifacts/jongio-azd-app-linux-amd64.tar.gz | awk '{print $1}')
          LINUX_ARM64_SHA=$(sha256sum /tmp/pr-artifacts/jongio-azd-app-linux-arm64.tar.gz | awk '{print $1}')
          WINDOWS_AMD64_SHA=$(sha256sum /tmp/pr-artifacts/jongio-azd-app-windows-amd64.zip | awk '{print $1}')
          WINDOWS_ARM64_SHA=$(sha256sum /tmp/pr-artifacts/jongio-azd-app-windows-arm64.zip | awk '{print $1}')
          
          sed -i "s/DARWIN_AMD64_CHECKSUM/${DARWIN_AMD64_SHA}/g" /tmp/pr-artifacts/pr-registry.json
          sed -i "s/DARWIN_ARM64_CHECKSUM/${DARWIN_ARM64_SHA}/g" /tmp/pr-artifacts/pr-registry.json
          sed -i "s/LINUX_AMD64_CHECKSUM/${LINUX_AMD64_SHA}/g" /tmp/pr-artifacts/pr-registry.json
          sed -i "s/LINUX_ARM64_CHECKSUM/${LINUX_ARM64_SHA}/g" /tmp/pr-artifacts/pr-registry.json
          sed -i "s/WINDOWS_AMD64_CHECKSUM/${WINDOWS_AMD64_SHA}/g" /tmp/pr-artifacts/pr-registry.json
          sed -i "s/WINDOWS_ARM64_CHECKSUM/${WINDOWS_ARM64_SHA}/g" /tmp/pr-artifacts/pr-registry.json
          
          echo "Generated PR registry with version ${VERSION}:"
          cat /tmp/pr-artifacts/pr-registry.json

      - name: Upload PR build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-${{ steps.pr.outputs.number }}-build
          path: /tmp/pr-artifacts/*
          retention-days: 90

      - name: Create lightweight release for registry only
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          PR_NUM="${{ steps.pr.outputs.number }}"
          
          # Create a lightweight tag and release with just the registry file
          # This allows one-line install scripts to work without gh auth
          # Binaries are distributed via artifacts to avoid cluttering releases
          gh release create "$TAG" \
            --title "PR #${PR_NUM} Registry (v${VERSION})" \
            --notes "Registry file for PR #${PR_NUM} build ${VERSION}. Download full build artifacts from [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})." \
            --prerelease \
            /tmp/pr-artifacts/pr-registry.json

      - name: Generate installation instructions
        id: instructions
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PR_NUM="${{ steps.pr.outputs.number }}"
          TAG="${{ steps.version.outputs.tag }}"
          REPO="${{ github.repository }}"
          COMMIT="${{ steps.pr.outputs.sha }}"
          SHORT_COMMIT=$(echo $COMMIT | cut -c1-7)
          # Use the branch where the scripts actually exist
          BRANCH="${{ github.ref_name }}"
          
          cat > ../instructions.md <<EOF
          ## ðŸš€ Test This PR
          
          A preview build (\`$VERSION\`) is ready for testing!
          
          ### One-Line Install (Recommended)
          
          **PowerShell (Windows):**
          \`\`\`powershell
          iex "& { \$(irm https://raw.githubusercontent.com/$REPO/$BRANCH/cli/scripts/install-pr.ps1) } -PrNumber $PR_NUM -Version $VERSION"
          \`\`\`
          
          **Bash (macOS/Linux):**
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/$REPO/$BRANCH/cli/scripts/install-pr.sh | bash -s $PR_NUM $VERSION
          \`\`\`
          
          ### Manual Installation
          
          <details>
          <summary>Click to expand manual installation steps</summary>
          
          **1. Download the PR build artifacts** from the [workflow run](https://github.com/$REPO/actions/runs/${{ github.run_id }})
          
          **2. Extract the artifacts:**
          \`\`\`bash
          unzip pr-$PR_NUM-build.zip
          \`\`\`
          
          **3. Add as a custom registry source:**
          \`\`\`bash
          azd config set alpha.extension.enabled on
          azd extension source add -n pr-$PR_NUM -t file -l "\$(pwd)/pr-registry.json"
          \`\`\`
          
          **4. Install the preview:**
          \`\`\`bash
          azd extension install jongio.azd.app --version $VERSION
          \`\`\`
          
          **5. Verify installation:**
          \`\`\`bash
          azd app version  # Should show: azd app extension version $VERSION
          azd app hi
          azd app reqs
          \`\`\`
          
          </details>
          
          ### Restore Stable Version
          
          When you're done testing, restore the stable version:
          
          **PowerShell (Windows):**
          \`\`\`powershell
          iex "& { \$(irm https://raw.githubusercontent.com/$REPO/$BRANCH/cli/scripts/restore-stable.ps1) }"
          \`\`\`
          
          **Bash (macOS/Linux):**
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/$REPO/$BRANCH/cli/scripts/restore-stable.sh | bash
          \`\`\`
          
          <details>
          <summary>Click to expand manual cleanup steps</summary>
          
          \`\`\`bash
          azd extension uninstall jongio.azd.app
          azd extension source remove pr-$PR_NUM
          rm pr-registry.json
          azd extension source add -n app -t url -l "https://raw.githubusercontent.com/$REPO/refs/heads/main/registry.json"
          azd extension install jongio.azd.app
          \`\`\`
          
          </details>
          
          ---
          
          **Build Info:**
          - **Version:** \`$VERSION\`
          - **Commit:** \`$SHORT_COMMIT\`
          - **Binaries:** [Download from workflow artifacts](https://github.com/$REPO/actions/runs/${{ github.run_id }})
          - **Registry:** [Download from release](https://github.com/$REPO/releases/tag/$TAG)
          - **Retention:** 90 days (artifacts), indefinite (registry)
          
          **What to Test:**
          Please review the PR description and test the changes described there.
          EOF

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const instructions = fs.readFileSync('instructions.md', 'utf8');
            const prNumber = '${{ steps.pr.outputs.number }}';
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸš€ Test This PR')
            );
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: instructions
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: instructions
              });
              console.log('Created new comment');
            }

  # Cleanup job - removes registry releases when PR closes
  cleanup:
    name: Cleanup PR Registry
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && github.event_name == 'pull_request_target'
    permissions:
      contents: write
    
    steps:
      - name: Delete PR registry release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          
          # Find and delete releases matching this PR
          gh release list --repo ${{ github.repository }} --json tagName,name --limit 100 | \
            jq -r ".[] | select(.tagName | contains(\"-pr${PR_NUM}\")) | .tagName" | \
            while read tag; do
              echo "Deleting release: $tag"
              gh release delete "$tag" --repo ${{ github.repository }} --yes || true
              # Delete tag
              git push --delete origin "$tag" 2>/dev/null || true
            done
