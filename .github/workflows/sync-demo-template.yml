name: Sync Demo Template

on:
  push:
    branches:
      - main
    paths:
      - 'cli/demo/**'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not push changes)'
        required: false
        default: false
        type: boolean

env:
  DEMO_SOURCE_PATH: cli/demo
  TARGET_REPO: jongio/azd-app-demo

jobs:
  sync:
    name: Sync Demo to Target Repository
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      secret_configured: ${{ steps.check-secret.outputs.configured }}
    
    steps:
      - name: Check for required secret
        id: check-secret
        env:
          DEMO_REPO_PAT: ${{ secrets.DEMO_REPO_PAT }}
        run: |
          if [ -z "$DEMO_REPO_PAT" ]; then
            echo "::warning::DEMO_REPO_PAT secret is not configured. Skipping sync to target repository."
            echo "To enable syncing, add a DEMO_REPO_PAT secret with a GitHub PAT that has access to ${{ env.TARGET_REPO }}"
            echo "configured=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "configured=true" >> $GITHUB_OUTPUT
          echo "secret_configured=true" >> $GITHUB_ENV

      - name: Validate PAT is not expired
        if: env.secret_configured == 'true'
        env:
          DEMO_REPO_PAT: ${{ secrets.DEMO_REPO_PAT }}
        run: |
          echo "Validating PAT has access to ${{ env.TARGET_REPO }}..."
          
          HTTP_STATUS=$(curl -s -o /tmp/gh_response.json -w "%{http_code}" \
            -H "Authorization: Bearer $DEMO_REPO_PAT" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ env.TARGET_REPO }}")
          
          if [ "$HTTP_STATUS" = "401" ]; then
            echo ""
            echo "=========================================="
            echo "❌ ERROR: DEMO_REPO_PAT HAS EXPIRED"
            echo "=========================================="
            echo ""
            echo "The Personal Access Token (PAT) stored in DEMO_REPO_PAT is invalid or expired."
            echo ""
            echo "To fix this:"
            echo "  1. Go to https://github.com/settings/tokens"
            echo "  2. Create a new PAT with 'repo' scope for ${{ env.TARGET_REPO }}"
            echo "  3. Update the DEMO_REPO_PAT secret at:"
            echo "     https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            exit 1
          elif [ "$HTTP_STATUS" = "403" ]; then
            echo ""
            echo "=========================================="
            echo "❌ ERROR: DEMO_REPO_PAT LACKS PERMISSIONS"
            echo "=========================================="
            echo ""
            echo "The PAT does not have sufficient permissions for ${{ env.TARGET_REPO }}."
            echo ""
            echo "Required permissions:"
            echo "  - Contents: Read and write"
            echo ""
            echo "Update the PAT at https://github.com/settings/tokens"
            echo ""
            exit 1
          elif [ "$HTTP_STATUS" = "404" ]; then
            echo ""
            echo "=========================================="
            echo "❌ ERROR: TARGET REPOSITORY NOT FOUND"
            echo "=========================================="
            echo ""
            echo "Repository ${{ env.TARGET_REPO }} does not exist or PAT lacks access."
            echo ""
            exit 1
          elif [ "$HTTP_STATUS" != "200" ]; then
            echo "Unexpected response (HTTP $HTTP_STATUS):"
            cat /tmp/gh_response.json
            exit 1
          fi
          
          echo "✓ PAT is valid and has read access to ${{ env.TARGET_REPO }}"
          
          # Check if PAT has write (push) permissions by checking the permissions field
          PUSH_PERMISSION=$(cat /tmp/gh_response.json | jq -r '.permissions.push // false')
          if [ "$PUSH_PERMISSION" != "true" ]; then
            echo ""
            echo "=========================================="
            echo "❌ ERROR: DEMO_REPO_PAT LACKS WRITE ACCESS"
            echo "=========================================="
            echo ""
            echo "The PAT can read ${{ env.TARGET_REPO }} but cannot push to it."
            echo ""
            echo "This can happen if:"
            echo "  1. The PAT is a fine-grained token without 'Contents: Read and write' permission"
            echo "  2. The PAT is a classic token without 'repo' scope"
            echo "  3. The repository has branch protection rules blocking the PAT"
            echo ""
            echo "To fix this:"
            echo "  - For fine-grained PATs: Ensure 'Contents' permission is set to 'Read and write'"
            echo "  - For classic PATs: Ensure 'repo' scope is enabled"
            echo "  - Update the secret at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            echo ""
            exit 1
          fi
          
          echo "✓ PAT has write access to ${{ env.TARGET_REPO }}"

      - name: Checkout source repository
        if: env.secret_configured == 'true'
        uses: actions/checkout@v4
        with:
          path: source

      - name: Validate source files exist
        if: env.secret_configured == 'true'
        run: |
          echo "Validating source demo directory exists..."
          if [ ! -d "source/${{ env.DEMO_SOURCE_PATH }}" ]; then
            echo "ERROR: Demo source directory not found at ${{ env.DEMO_SOURCE_PATH }}"
            exit 1
          fi
          
          echo "Source directory contents:"
          ls -la "source/${{ env.DEMO_SOURCE_PATH }}"

      - name: Validate required files
        if: env.secret_configured == 'true'
        run: |
          DEMO_PATH="source/${{ env.DEMO_SOURCE_PATH }}"
          MISSING_FILES=""
          
          # Check for required files
          REQUIRED_FILES=(
            "azure.yaml"
            ".vscode/mcp.json"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$DEMO_PATH/$file" ]; then
              MISSING_FILES="$MISSING_FILES\n  - $file"
            else
              echo "✓ Found: $file"
            fi
          done
          
          if [ -n "$MISSING_FILES" ]; then
            echo "ERROR: Required files missing:$MISSING_FILES"
            exit 1
          fi
          
          echo ""
          echo "All required files present!"

      - name: Checkout target repository
        if: env.secret_configured == 'true'
        id: checkout-target
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.DEMO_REPO_PAT }}
          path: target
          fetch-depth: 0

      - name: Initialize empty target repository
        if: env.secret_configured == 'true' && steps.checkout-target.outcome == 'failure'
        env:
          DEMO_REPO_PAT: ${{ secrets.DEMO_REPO_PAT }}
        run: |
          echo "Target repository appears to be empty. Initializing..."
          # Clean up any partial checkout and start fresh
          rm -rf target
          mkdir -p target
          cd target
          git init
          git remote add origin "https://x-access-token:${DEMO_REPO_PAT}@github.com/${{ env.TARGET_REPO }}.git"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Create an initial empty commit so we have a branch to work with
          git commit --allow-empty -m "chore: initialize repository"
          echo "✓ Initialized empty repository"

      - name: Sync demo files to target
        if: env.secret_configured == 'true'
        run: |
          DEMO_PATH="source/${{ env.DEMO_SOURCE_PATH }}"
          
          echo "Syncing files from $DEMO_PATH to target repository..."
          
          # Remove all files from target except .git
          cd target
          find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} \;
          cd ..
          
          # Copy all files from demo source to target root
          # Using rsync to handle hidden files properly
          rsync -av --exclude='.git' "$DEMO_PATH/" target/
          
          echo ""
          echo "Target repository contents after sync:"
          ls -la target/
          
          # Show .vscode directory
          if [ -d "target/.vscode" ]; then
            echo ""
            echo ".vscode directory contents:"
            ls -la target/.vscode/
          fi

      - name: Check for changes
        if: env.secret_configured == 'true'
        id: changes
        working-directory: target
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --staged --stat
          fi

      - name: Commit and push changes
        if: env.secret_configured == 'true' && steps.changes.outputs.has_changes == 'true' && (github.event.inputs.dry_run != 'true')
        working-directory: target
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Get the source commit SHA for reference
          SOURCE_SHA="${{ github.sha }}"
          SHORT_SHA="${SOURCE_SHA:0:7}"
          
          git commit -m "chore: sync demo template from azd-app ($SHORT_SHA)" \
            -m "Synced from: https://github.com/${{ github.repository }}/commit/$SOURCE_SHA" \
            -m "Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          git push origin main
          
          echo "✓ Changes pushed to ${{ env.TARGET_REPO }}"

      - name: Dry run summary
        if: env.secret_configured == 'true' && github.event.inputs.dry_run == 'true'
        run: |
          echo "DRY RUN: Changes were not pushed"
          echo "The following changes would have been made:"
          cd target
          git diff --staged --stat

  smoke-test:
    name: Smoke Test Demo
    runs-on: ubuntu-latest
    needs: sync
    if: always() && needs.sync.result == 'success' && needs.sync.outputs.secret_configured == 'true'
    
    steps:
      - name: Checkout synced demo repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.DEMO_REPO_PAT }}

      - name: Install azd
        run: curl -fsSL https://aka.ms/install-azd.sh | bash

      - name: Install azd-app extension
        run: |
          # Add the extension registry and install azd-app
          azd extension source add jongio --location https://raw.githubusercontent.com/jongio/azd-app/main/registry.json --type url 2>/dev/null || true
          azd extension install jongio.azd.app --source jongio || echo "Extension may not be published yet, continuing..."

      - name: Validate azure.yaml exists
        run: |
          if [ ! -f "azure.yaml" ]; then
            echo "ERROR: azure.yaml not found in demo repository"
            exit 1
          fi
          echo "✓ azure.yaml exists"
          cat azure.yaml

      - name: Validate .vscode/mcp.json exists
        run: |
          if [ ! -f ".vscode/mcp.json" ]; then
            echo "ERROR: .vscode/mcp.json not found in demo repository"
            exit 1
          fi
          echo "✓ .vscode/mcp.json exists"
          cat .vscode/mcp.json

      - name: Run azd app reqs (smoke test)
        continue-on-error: true
        run: |
          echo "Running: azd app reqs"
          azd app reqs || echo "Note: azd app reqs may fail if extension is not yet published"

      - name: Run azd app deps (smoke test)
        continue-on-error: true
        run: |
          echo "Running: azd app deps"
          azd app deps || echo "Note: azd app deps may fail if extension is not yet published"

      - name: Smoke test summary
        run: |
          echo ""
          echo "=========================================="
          echo "Smoke Test Summary"
          echo "=========================================="
          echo "✓ Demo repository structure validated"
          echo "✓ Required files present"
          echo ""
          echo "Note: Full azd app commands may not work until:"
          echo "  1. The azd-app extension is published"
          echo "  2. The demo project has all required dependencies"
